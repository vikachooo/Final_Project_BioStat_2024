---
title: "Indicators Analysis"
author: "Victoria Zaitceva"
date: "`r Sys.Date()`"
output: 
   html_document:
       toc: true
       toc_float:
           collapsed: false
           smooth_scroll: true
       theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(ggpubr)
library(tidyr)
library(anytime)
library(lubridate)
library(zoo)
library(patchwork)



theme_custom <- theme(
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    strip.text = element_text(size = 10),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1), #rotate
    axis.title = element_text(size = 10),
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 9)
  )
```


```{r}
database_summarized_month <- read.table("data/data_summarized_by_month_Kravets.tsv", header = TRUE, sep = "\t")
```


gvv,bsp and b2 - type 2 - Региональные сосудистые центры
b15 - type 1 - Первичное сосудистое отделение, там не все индикаторы качества выполняются, поэтому я бы его исключила и вообще сравнивала РСЦ и ПСО отдельно

```{r, echo=TRUE}
group1 <- c("gvv","bsp","b2", "b15")
all_data_group1 <- database_summarized_month %>% filter(hosp %in% group1)


highlighted_dates <- seq(as.Date("2020-03-01"), as.Date("2021-12-01"), by = "quarter")
```



# Структура заболеваемости

## Возраст - Общегородская динамика возрастной структуры пациентов (все центры)


```{r, eval=FALSE}

data_for_plot <- database_summarized_month %>%
  select(year, Младше_45_лет, От_45_до_60_лет, Старше_60_лет, `Пролечены_с_ОНМК_Всего`) %>%
  group_by(year) %>%
  summarise(
    Младше_45_лет = sum(Младше_45_лет, na.rm = TRUE),
    От_45_до_60_лет = sum(От_45_до_60_лет, na.rm = TRUE),
    Старше_60_лет = sum(Старше_60_лет, na.rm = TRUE),
    annual_total = sum(`Пролечены_с_ОНМК_Всего`, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    Младше_45_лет = Младше_45_лет / annual_total * 100,
    От_45_до_60_лет = От_45_до_60_лет / annual_total * 100,
    Старше_60_лет = Старше_60_лет / annual_total * 100
  ) %>%
  pivot_longer(
    cols = c(Младше_45_лет, От_45_до_60_лет, Старше_60_лет),
    names_to = "Age_Category",
    values_to = "Percentage"
  ) %>%
  mutate(
    Age_Category = factor(Age_Category, 
                            levels = c("Младше_45_лет", "От_45_до_60_лет", "Старше_60_лет"))
  )




ggplot(data_for_plot, aes(x = year, y = Percentage, fill = Age_Category)) +
  geom_bar(stat = "identity") + 
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  
  scale_fill_manual(
    values = c("Младше_45_лет" = "#1f77b4", 
               "От_45_до_60_лет" = "darkred", 
               "Старше_60_лет" = "darkgrey"),  
    name = "Возраст" 
  ) +
  labs(
    title = "Общегородская динамика возрастной структуры пациентов",
    x = "",
    y = "% от всех законченных случаев"
  ) +
  theme_custom
```

## NIHSS - Общий городской уровень тяжести по NIHSS (все центры)


```{r}


data_for_plot <- database_summarized_month %>%
  select(year, `NIHSS_Меньше_4`, `NIHSS_5_20`, `NIHSS_Больше_21`, `Пролечены_с_ОНМК_Всего`) %>%
  group_by(year) %>%
  summarise(
    NIHSS_Меньше_4 = sum(NIHSS_Меньше_4, na.rm = TRUE),
    NIHSS_5_20 = sum(NIHSS_5_20, na.rm = TRUE),
    NIHSS_Больше_21 = sum(NIHSS_Больше_21, na.rm = TRUE),
    annual_total = sum(`Пролечены_с_ОНМК_Всего`, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    NIHSS_Меньше_4 = NIHSS_Меньше_4 / annual_total * 100,
    NIHSS_5_20 = NIHSS_5_20 / annual_total * 100,
    NIHSS_Больше_21 = NIHSS_Больше_21 / annual_total * 100
  ) %>%
  pivot_longer(
    cols = c(NIHSS_Меньше_4, NIHSS_5_20, NIHSS_Больше_21),
    names_to = "NIHSS_Category",
    values_to = "Percentage"
  ) %>%
  mutate(
    NIHSS_Category = factor(NIHSS_Category, 
                            levels = c("NIHSS_Меньше_4", "NIHSS_5_20", "NIHSS_Больше_21"))
  )





ggplot(data_for_plot, aes(x = year, y = Percentage, fill = NIHSS_Category)) +
  geom_bar(stat = "identity", position = "stack") +  
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  
  scale_fill_manual(
    values = c("NIHSS_Меньше_4" = "#1f77b4", 
               "NIHSS_5_20" = "darkred", 
               "NIHSS_Больше_21" = "darkgrey"),  
    name = "Категория NIHSS"  
  ) +
  labs(
    title = "Общегородская динамика\n по уровням тяжести пациентов NIHSS",
    x = "",
    y = "% от всех законченных случаев"
  ) +
  theme_custom

```

## Динамика в структуре заболевания (%) по годам общегородская, line plot


```{r, fig.width = 12, fig.height = 2.5}

stroke_types <- c("ИИ_Ишемический_Инсульт", "ГИ_Геморрагический_Инсульт", "ТИА_Транзиторная_Ишемическая_Атака")

plots <- list()



for (type in stroke_types) {
  

  temp <- database_summarized_month %>%
    group_by(year) %>%
    summarise(
      !!sym(type) := sum(!!sym(type), na.rm = TRUE),
      Пролечены_с_ОНМК_Всего = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      Percentage = !!sym(type) / Пролечены_с_ОНМК_Всего * 100
    ) %>%
    group_by(year) %>%
    summarise(
      Percentage = mean(Percentage, na.rm = TRUE),
      .groups = "drop"
    )
  
  

  plot <- ggplot(temp, aes(x = year, y = Percentage)) +
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(2017, 2024, by = 1))+
    labs(
      title = paste(type),
      x = NULL,
      y = NULL
    ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 8))
  

  plots[[type]] <- plot
}



combined_plot <- ggarrange(
  plotlist = plots, 
  ncol = 3, 
  nrow = 1,
  widths = c(1,1,1), 
  common.legend = TRUE,  
  labels = NULL          
)



final_plot <- annotate_figure(
  combined_plot,
  top = text_grob("Динамика в структуре заболевания (%)\n по годам общегородская", size = 12, face = "bold"), 
  left = text_grob("% от общего числа пролеченных", size = 10, face = "plain", rot = 90)   
)


print(final_plot)
```


## Динамика в структуре заболевания (%) общегородская - по месяцам, line plot

Сделала линию тренда, чтобы просто показать как линия выглядит если делать по месяца, но предлагаю для любых показателей по месяцам точки получше выглядят.

Линии только для годовой динамики.

```{r, fig.width = 12, fig.height = 2.5}


stroke_types <- c("ИИ_Ишемический_Инсульт", "ГИ_Геморрагический_Инсульт", "ТИА_Транзиторная_Ишемическая_Атака")

plots <- list()



for (type in stroke_types) {
  

  temp <- database_summarized_month %>%
    mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
    group_by(year_month) %>%
    summarise(
      !!sym(type) := sum(!!sym(type), na.rm = TRUE),
      Пролечены_с_ОНМК_Всего = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      Percentage = !!sym(type) / Пролечены_с_ОНМК_Всего * 100
    ) %>%
    group_by(year_month) %>%
    summarise(
      Percentage = mean(Percentage, na.rm = TRUE),
      .groups = "drop"
    )
  
  temp$year_month_num <- as.numeric(as.Date(temp$year_month))
  

  plot <- ggplot(temp, aes(x = year_month, y = Percentage)) +
    geom_point(size = 1) +
    geom_line() +
    geom_smooth(method = "loess", span = 0.5, se = TRUE, color = "blue") +
    labs(
      title = paste(type),
      x = NULL,
      y = NULL
    ) +
    scale_x_date(
    date_breaks = "3 month",      
    date_labels = "%Y-%m"          
  ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 8),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 5))
  

  plots[[type]] <- plot
}


combined_plot <- ggarrange(
  plotlist = plots, 
  ncol = 3, 
  nrow = 1,
  widths = c(1,1,1), 
  common.legend = TRUE,  
  labels = NULL          
)



final_plot <- annotate_figure(
  combined_plot,
  top = text_grob("Динамика в структуре заболевания (%) общегородская", size = 12, face = "bold"),  # Common title
  bottom = text_grob("", size = 12, face = "plain"),  # Common x-axis title
  left = text_grob("% от общего числа пролеченных", size = 10, face = "plain", rot = 90)  # Common y-axis title
)


print(final_plot)

```


## Динамика структуры заболеваемости по месяцам в группе 1 (% от общего числа пролеченных)

То же самое, что и сверху, but scatter plot

```{r, fig.width = 12, fig.height = 2.5}


stroke_types <- c("ИИ_Ишемический_Инсульт", "ГИ_Геморрагический_Инсульт", "ТИА_Транзиторная_Ишемическая_Атака")

plots <- list()



for (type in stroke_types) {
  

  temp <- all_data_group1 %>%
    mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
    group_by(year_month) %>%
    summarise(
      !!sym(type) := sum(!!sym(type), na.rm = TRUE),
      Пролечены_с_ОНМК_Всего = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      Percentage = !!sym(type) / Пролечены_с_ОНМК_Всего * 100
    ) %>%
    group_by(year_month) %>%
    summarise(
      Percentage = mean(Percentage, na.rm = TRUE),
      .groups = "drop"
    )
  

  #temp$year_month_num <- as.numeric(as.Date(temp$year_month))
  

  #correlation <- cor.test(temp$year_month_num, temp$Percentage)
  

  plot <- ggplot(temp, aes(x = year_month, y = Percentage)) +
    geom_point(size = 0.8) +
    geom_line(size = 0.5) +
    geom_smooth(method = "loess", span = 0.5, se = TRUE, color = "darkred") +
    #annotate(
      #"text", 
      #x = max(temp$year_month), 
      #y = max(temp$Percentage, na.rm = TRUE),
      #label = paste("r =", round(correlation$estimate, 2), 
                  #  "\nP =", signif(correlation$p.value, 2)),
      #hjust = 1, vjust = 1) +
    
    labs(
      title = paste(type),
      x = NULL,
      y = NULL
    ) +
    scale_x_date(
    date_breaks = "3 month",      
    date_labels = "%Y-%m"          
  ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 8),
      axis.text.x = element_text(angle = 90, hjust = 1, size = 5))
  

  plots[[type]] <- plot
}


combined_plot <- ggarrange(
  plotlist = plots, 
  ncol = 3, 
  nrow = 1,
  widths = c(1,1,1), 
  common.legend = TRUE,  
  labels = NULL         
)



final_plot <- annotate_figure(
  combined_plot,
  top = text_grob("Dymanics of stroke types (%) by month in group 1", size = 12, face = "bold"),
  left = text_grob("% total number treated", size = 10, face = "plain", rot = 90)  # Common y-axis title
)


print(final_plot)

ggsave("images/structure_stroke_group1.png", final_plot, width = 12, height = 2.5)

```

# ИИ процедуры (тромболизис и др)

## Годовая доля тромболизиса от общего числа ИИ случаев - line plot

```{r}
data_prepared <- all_data_group1 %>%
  # метка для объединенного графика
  mutate(hosp_combined = "Суммарно") %>%
  # общее количество летальных исходов и пролеченных случаев по году и центру
  group_by(hosp, year) %>%
  summarise(
    total_thromb = sum(Тромболизис, na.rm = TRUE),  # Общее число тромболизиса
    total_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),  # Общее число ИИ случаев
    .groups = "drop"
  ) %>%
  # процент для каждого госпиталя
  mutate(
    thromb_проц = total_thromb / total_cases * 100
  ) %>%
  # суммарный график
  bind_rows(
    all_data_group1 %>%
      group_by(year) %>%
      summarise(
        total_thromb = sum(Тромболизис, na.rm = TRUE),
        total_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        hosp = "Суммарно",  
        thromb_проц = total_thromb / total_cases * 100
      )
  )


ggplot(data_prepared, aes(x = year, y = thromb_проц, colour = hosp)) +
  geom_line(color = "black") + 
  geom_point(color = "black") +  
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) + 
  labs(
    title = "Годовая доля тромболизиса от общего числа ИИ случаев",
    x = "",
    y = "%"
  ) +
  theme_custom +
  facet_wrap(vars(hosp), scales = "free") 

```

## Процедуры при ИИ по годам в группе 1 , РСЦ

% от общего числа ИИ

```{r, fig.width = 12, fig.height = 2.5}

indicators_II <- c("Тромболизис", "Тромбэкстракция", "Комбинированная_Реперфузия", "Реваскуляризация_Острый_Период")


plots <- list()



for (indicator in indicators_II) {
  
  temp <- all_data_group1 %>%
    group_by(hosp, year) %>%
    summarise(
      !!sym(indicator) := sum(!!sym(indicator), na.rm = TRUE),
      ИИ_Ишемический_Инсульт = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      Percentage = !!sym(indicator) / ИИ_Ишемический_Инсульт * 100
    ) %>%
    group_by(year) %>%
    summarise(
      Percentage = mean(Percentage, na.rm = TRUE),
      .groups = "drop"
    )
  



  plot <- ggplot(temp, aes(x = year, y = Percentage)) +
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(2017, 2024, by = 1)) +
    labs(
      title = paste(indicator),
      x = NULL,
      y = NULL
    ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 8))
  

  plots[[indicator]] <- plot
}


combined_plot <- ggarrange(
  plotlist = plots, 
  ncol = 4, 
  nrow = 1,
  common.legend = TRUE,  
  labels = NULL          
)



final_plot <- annotate_figure(
  combined_plot,
  top = text_grob("Выполнение процедур при ИИ (%) в группе 1", size = 12, face = "bold"),  
  bottom = text_grob("Год", size = 12, face = "plain"),  
  left = text_grob("% от общего числа ИИ пациентов", size = 10, face = "plain", rot = 90)  
)


print(final_plot)


```




## Процедуры при ИИ по месяцам в группе 1 , РСЦ

% each treatment от sum(ИИ_Ишемический_Инсульт)

```{r, fig.width = 12, fig.height = 4}

indicators_II <- c("Тромболизис", "Тромбэкстракция", "Комбинированная_Реперфузия", "Реваскуляризация_Острый_Период")


plots <- list()


for (indicator in indicators_II) {
  
  temp <- all_data_group1 %>%
    mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
    group_by(hosp, year_month) %>%
    summarise(
      !!sym(indicator) := sum(!!sym(indicator), na.rm = TRUE),
      ИИ_Ишемический_Инсульт = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      Percentage = !!sym(indicator) / ИИ_Ишемический_Инсульт * 100
    ) %>%
    group_by(year_month) %>%
    summarise(
      Percentage = mean(Percentage, na.rm = TRUE),
      .groups = "drop"
    )
  
  # correlation calculation
  #temp$year_month_num <- as.numeric(as.Date(temp$year_month))
  #correlation <- cor.test(temp$year_month_num, temp$Percentage)
  

  plot <- ggplot(temp, aes(x = year_month, y = Percentage)) +
    geom_point(size = 0.8) +
    geom_line(size = 0.5) +
    geom_smooth(method = "loess", se = TRUE, color = "darkred") +
    #annotate(
      #"text", 
      #x = max(temp$year_month), 
      #y = max(temp$Percentage, na.rm = TRUE),
      #label = paste("r =", round(correlation$estimate, 2), 
                    #"\nP =", signif(correlation$p.value, 2)),
      #hjust = 1, vjust = 1,  # Align text to bottom-right
      #size = 3  # Reduced text size) +
    labs(
      title = paste(indicator),
      x = NULL,
      y = NULL
    ) +
    scale_x_date(
      date_breaks = "3 month",
      date_labels = "%Y-%m") +
    theme_custom +
    theme(
      plot.title = element_text(size = 8),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 4))
  

  plots[[indicator]] <- plot
}


combined_plot <- ggarrange(
  plotlist = plots, 
  ncol = 2, 
  nrow = 2,
  common.legend = TRUE,  
  labels = NULL          
)



final_plot <- annotate_figure(
  combined_plot,
  top = text_grob("Ishemic stroke treatments (%) in group 1", size = 12, face = "bold"),  
  left = text_grob("% total IS patients", size = 10, face = "plain", rot = 90)  
)


print(final_plot)

ggplot2::ggsave("images/procedures_group1_total_patients.png", final_plot, width = 12, height = 4)

```

Каждая процедура зависит от тяжести по NIHSS, возможно надо считать каждую процедуру как % от числа пациентов с определенным NIHSS, а не от общего числа ИИ пациентов.

Типы процедур при ИИ явно не суммируются в 100%, поэтому что-то отсутсвует в данных





Может быть посмотреть как соотношение уровней тяжести для каждого типа процедур меняется во времени
Один центр - один график, где по оси Х - год, а по оси Y - барплоты с разными процетными соотношениями уровней тяжести.

Процедура - барплоты, разделенные по уровням тяжести


Количество суммарных ИИ процедур не равняется общему числу ИИ случаев

```{r}
all_data_group1 |> select(ИИ_Ишемический_Инсульт, Тромболизис, Тромбэкстракция, 
                          Комбинированная_Реперфузия, Реваскуляризация_Острый_Период) |>
  mutate(treatments_done = rowSums(across(-ИИ_Ишемический_Инсульт), na.rm = TRUE)) |> View()

```


Посмотреть доли процедур от общего числа ИИ процедур, не ИИ случаев


each treatment / sum(Тромболизис, Тромбэкстракция, Комбинированная_Реперфузия, Реваскуляризация_Острый_Период)

IGNORE

```{r, fig.width = 12, fig.height = 4}
indicators_II <- c("Тромболизис", "Тромбэкстракция", "Комбинированная_Реперфузия", "Реваскуляризация_Острый_Период")


plots <- list()


for (indicator in indicators_II) {
  
   temp <- all_data_group1 %>%
    mutate(
      year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))
    ) %>%
    group_by(hosp, year_month) %>%
    summarise(
      # Calculate the total number of each treatment
      !!sym(indicator) := sum(!!sym(indicator), na.rm = TRUE),
      # Calculate the total treatments done (all indicators)
      Total_Treatments = sum(Тромболизис, Тромбэкстракция, Комбинированная_Реперфузия, Реваскуляризация_Острый_Период, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      # Percentage of the specific treatment relative to total treatments
      Percentage = !!sym(indicator) / Total_Treatments * 100
    ) %>%
    group_by(year_month) %>%
    summarise(
      # Average percentage across hospitals
      Percentage = mean(Percentage, na.rm = TRUE),
      .groups = "drop"
    )


  
  # correlation calculation
  #temp$year_month_num <- as.numeric(as.Date(temp$year_month))
  #correlation <- cor.test(temp$year_month_num, temp$Percentage)
  

  plot <- ggplot(temp, aes(x = year_month, y = Percentage)) +
    geom_point(size = 0.8) +
    geom_line(size = 0.5) +
    geom_smooth(method = "loess", se = TRUE, color = "darkred") +
    #annotate(
      #"text", 
      #x = max(temp$year_month), 
      #y = max(temp$Percentage, na.rm = TRUE),
      #label = paste("r =", round(correlation$estimate, 2), 
                    #"\nP =", signif(correlation$p.value, 2)),
      #hjust = 1, vjust = 1,  # Align text to bottom-right
      #size = 3  # Reduced text size) +
    labs(
      title = paste(indicator),
      x = NULL,
      y = NULL
    ) +
    scale_x_date(
    date_breaks = "3 month",      
    date_labels = "%Y-%m"          
  ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 8),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 4))
  

  plots[[indicator]] <- plot
}


combined_plot <- ggarrange(
  plotlist = plots, 
  ncol = 2, 
  nrow = 2,
  common.legend = TRUE,  
  labels = NULL          
)



final_plot <- annotate_figure(
  combined_plot,
  top = text_grob("Ishemic stroke treatments (%) in group 1", size = 12, face = "bold"),  
  left = text_grob("% total IS treatmets done", size = 10, face = "plain", rot = 90)  
)


print(final_plot)

ggplot2::ggsave("images/procedures_group1_total_treatments.png", final_plot, width = 12, height = 4)

```


## Only thrombolysis by month

Тромболизис / ИИ_Ишемический_Инсульт

```{r}
data_prepared <- all_data_group1 %>%
  # Create year_month column
  mutate(year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))) %>%
  group_by(hosp, year_month) %>%
  summarise(
    total_thromb = sum(Тромболизис, na.rm = TRUE), 
    total_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  mutate(
    Летальные_Исходы_проц = total_thromb / total_cases * 100
  ) 

# Plot
ggplot(data_prepared, aes(x = year_month, y = Летальные_Исходы_проц, colour = hosp)) +
  geom_line(color = "black", size = 0.5) +  
  geom_point(color = "black", size = 0.8) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "darkred") +
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") + 
  labs(
    title = "Thrombolysis rate in group 1",
    x = "",
    y = "% from total IS cases"
  ) +
  facet_wrap(vars(hosp), scales = "free") +  # Facet by hospital
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1, size = 4)
  )


ggplot2::ggsave("images/thromb_montn_by_hosp_group1.png")
```
total group 1

```{r}
data_prepared <- all_data_group1 %>%
  # Create year_month column
  mutate(year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))) %>%
  group_by(year_month) %>%
  summarise(
    total_thromb = sum(Тромболизис, na.rm = TRUE), 
    total_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  mutate(
    Летальные_Исходы_проц = total_thromb / total_cases * 100
  ) 

# Plot
ggplot(data_prepared, aes(x = year_month, y = Летальные_Исходы_проц, colour = hosp)) +
  geom_line(color = "black", size = 0.7) +  
  geom_point(color = "black", size = 0.8) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "darkred") +
  scale_x_date(date_breaks = "3 months", 
               date_labels = "%Y-%m") + 
  labs(
    title = "Total group 1",
    x = "",
    y = "% from total IS cases"
  ) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1, size = 7)
  )


ggplot2::ggsave("images/thromb_montn_total_group1.png")
```


# Категории NIHSS для процедур при ИИ

Может быть для каждой категории NIHSS характерна своя процедура?

Для проекта наверно неинформативно, просто решила посмотреть.

```{r}

NIHHS <- c("NIHSS_Меньше_4", "NIHSS_5_20", "NIHSS_Больше_21")
indicators_II <- c("Тромболизис", "Тромбэкстракция", "Комбинированная_Реперфузия", "Реваскуляризация_Острый_Период")


plots <- list()

for (procedure in indicators_II) {
  temp <- all_data_group1 %>%
    select(year, hosp, all_of(NIHHS), !!sym(procedure)) %>%
    group_by(year) %>%
    summarise(
      across(all_of(NIHHS), sum, na.rm = TRUE),
      procedure_total = sum(!!sym(procedure), na.rm = TRUE),
      .groups = "drop"
    ) %>%

    pivot_longer(
      cols = starts_with("NIHSS"),
      names_to = "NIHSS_Category",
      values_to = "Count"
    ) %>%
      mutate(
    NIHSS_Category = factor(NIHSS_Category, 
                            levels = c("NIHSS_Меньше_4", "NIHSS_5_20", "NIHSS_Больше_21"))
  )
  

  plot <- ggplot(temp, aes(x = year, y = Count, fill = NIHSS_Category)) +
    geom_bar(stat = "identity", position = "fill") + 
    scale_fill_manual(
      values = c("NIHSS_Меньше_4" = "#1f77b4", 
                 "NIHSS_5_20" = "darkred", 
                 "NIHSS_Больше_21" = "darkgrey"),
      name = "Категория:"
    ) +
    scale_x_continuous(breaks = seq(2017, 2024, by = 1)) +
    scale_y_continuous(labels = scales::percent_format(scale = 100)) +  
    labs(
      title = procedure,
      x = "",
      y = ""
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 10, hjust = 0.5),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 8)
    )
  

  plots[[procedure]] <- plot
}


combined_plot <- ggarrange(
  plotlist = plots,
  ncol = 2,  
  nrow = 2,  
  common.legend = TRUE,
  legend = "bottom"
) %>%
  annotate_figure(
  combined_plot,
  top = text_grob("Категории пациентов для процедур при ИИ", size = 12, face = "bold"))  


print(combined_plot)

```
Процентные соотношения аналогичны общегородским в целом.



# Летальные исходы

## Общегородская доля летальных исходов от общего числа пролеченных случаев


```{r}
data_aggregated <- database_summarized_month %>%
  group_by(year) %>%
  summarise(
    total_deaths = sum(Летальные_Исходы, na.rm = TRUE), 
    total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  mutate(
    Летальные_Исходы_проц = total_deaths / total_cases * 100
  ) %>%
  pivot_longer(
    cols = c(Летальные_Исходы_проц),
    names_to = "type",
    values_to = "percentage"
  )


ggplot(data_aggregated, aes(x = year, y = percentage, color = type)) +
  geom_line(color = "black") + 
  geom_point(color = "black") + 
  labs(
    title = "Общегородская доля летальных исходов",
    x = "",
    y = "%"
  ) +
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) +  
  theme_custom +
  theme(
    legend.position = "none"
  
  )

```


## Годовая доля летальных исходов в группе 1


```{r, fig.width = 12, fig.height = 4}

data_prepared <- all_data_group1 %>%
  # Create year_month column
  mutate(year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))) %>%
  group_by(hosp, year_month) %>%
  summarise(
    total_deaths = sum(Летальные_Исходы, na.rm = TRUE), 
    total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  mutate(
    Летальные_Исходы_проц = total_deaths / total_cases * 100
  ) %>%
  # Add combined data for "Суммарно"
  bind_rows(
    all_data_group1 %>%
      mutate(year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))) %>%
      group_by(year_month) %>%
      summarise(
        total_deaths = sum(Летальные_Исходы, na.rm = TRUE),
        total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        hosp = "Total group 1",  # Label for combined data
        Летальные_Исходы_проц = total_deaths / total_cases * 100
      )
  )

# Plot
ggplot(data_prepared, aes(x = year_month, y = Летальные_Исходы_проц, colour = hosp)) +
  geom_line(color = "black") +  
  geom_point(color = "black", size = 0.9) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "darkred") +
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") + 
  labs(
    title = "Monthly mortality rate in group 1",
    x = "",
    y = "%"
  ) +
  facet_wrap(vars(hosp), scales = "free") +  # Facet by hospital
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 4)
  )


#ggplot2::ggsave("images/mortality_group1.png", width = 12, height = 4)

```


Moving

```{r}
data_prepared <- all_data_group1 %>%
  # Create year_month column
  mutate(year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))) %>%
  group_by(hosp, year_month) %>%
  summarise(
    total_deaths = sum(Летальные_Исходы, na.rm = TRUE), 
    total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  mutate(
    Летальные_Исходы_проц = total_deaths / total_cases * 100
  ) 

# Plot
ggplot(data_prepared, aes(x = year_month, y = Летальные_Исходы_проц, colour = hosp)) +
  geom_line(color = "black", size = 0.5) +  
  geom_point(color = "black", size = 0.8) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "darkred") +
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") + 
  labs(
    title = "Monthly mortality rate in group 1",
    x = "",
    y = "% from total treated"
  ) +
  facet_wrap(vars(hosp), scales = "free") +  # Facet by hospital
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1, size = 4)
  )


ggplot2::ggsave("images/by_hosp_montn_mortality_group1.png")
```




```{r}
data_prepared <- all_data_group1 %>%
      mutate(year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))) %>%
      group_by(year_month) %>%
      summarise(
        total_deaths = sum(Летальные_Исходы, na.rm = TRUE),
        total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        Летальные_Исходы_проц = total_deaths / total_cases * 100
      )
  

# Plot
ggplot(data_prepared, aes(x = year_month, y = Летальные_Исходы_проц, colour = hosp)) +
  geom_line(color = "black", size = 0.5) +  
  geom_point(color = "black", size = 0.8) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "darkred") +
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-%m") + 
  labs(
    title = "Total group 1",
    x = "",
    y = "% from total treated"
  ) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1, size = 4)
  )


ggplot2::ggsave("images/total_month_mortality_group1.png")
```





% от Пролечены_с_ОНМК_Всего

```{r}

data_prepared <- all_data_group1 %>%
  mutate(hosp_combined = "Суммарно") %>%
  # общее количество летальных исходов и пролеченных случаев по году и центру
  group_by(hosp, year) %>%
  summarise(
    total_deaths = sum(Летальные_Исходы, na.rm = TRUE), 
    total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  mutate(
    Летальные_Исходы_проц = total_deaths / total_cases * 100
  ) %>%
  # суммарный график
  bind_rows(
    all_data_group1 %>%
      group_by(year) %>%
      summarise(
        total_deaths = sum(Летальные_Исходы, na.rm = TRUE),
        total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        hosp = "Суммарно",  # Метка для общего графика
        Летальные_Исходы_проц = total_deaths / total_cases * 100
      )
  )




ggplot(data_prepared, aes(x = year, y = Летальные_Исходы_проц, colour = hosp)) +
  geom_line(color = "black") +  
  geom_point(color="black") +  
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) + 
  labs(
    title = "Годовая доля летальных исходов в группе 1",
    x = "Год",
    y = "Процент"
  ) +
  theme_custom +
  facet_wrap(vars(hosp), scales = "free") 


```

(Не могу сделать Годовая доля летальных исходов в зависимости от типа инсульта в группе 1 , потому что это неизвестно)


## Динамика летальных исходов по месяцам в группе 1 - line plot

```{r, fig.width = 12, fig.height = 3}
temp<- all_data_group1 %>%
    mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
    group_by(hosp, year_month) %>%
    summarise(
    total_deaths = sum(Летальные_Исходы, na.rm = TRUE), 
    total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  mutate(
    Летальные_Исходы_проц = total_deaths / total_cases * 100
  )


ggplot(temp, aes(x=year_month, y=Летальные_Исходы_проц))+
  geom_point()+
  geom_line() +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "blue") +
  labs(
    title = "Месячная доля летальных исходов в группе 1",
    x = "",
    y = "%"
  ) +
  scale_x_date(
    date_breaks = "1 month",      
    date_labels = "%Y-%m"          
  ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 8),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 5))
```

## Летальные исходы в сутки - ?

Это среднее число за неделю?


# Терапевтическое окно


## Годовые общегородские доли пациентов, попавших в ТО (4.5 часа)

```{r}

data_aggregated <- database_summarized_month %>%
  group_by(year) %>%
  summarise(
    total_ii_window = sum(ИИ_Терапевтическое_Окно, na.rm = TRUE),
    total_gi_window = sum(ГИ_Терапевтическое_Окно, na.rm = TRUE),
    total_ii_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),
    total_gi_cases = sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    ii_проц = total_ii_window / total_ii_cases * 100,
    gi_проц = total_gi_window / total_gi_cases * 100
  ) %>%
  pivot_longer(
    cols = c(ii_проц, gi_проц),
    names_to = "type",
    values_to = "percentage"
  )


ggplot(data_aggregated, aes(x = year, y = percentage, color = type)) +
  geom_line() + 
  geom_point() + 
  scale_color_manual(
    values = c("ii_проц" = "#1f77b4", "gi_проц" = "darkred"),
    labels = c("ii_проц" = "ИИ", "gi_проц" = "ГИ"),
    name = "Тип инсульта"
  ) +
  labs(
    title = "Общегородские доли пациентов, попавших в ТО (4.5 часа)",
    x = "",
    y = "%"
  ) +
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) +  
  theme_custom +
  theme(
    legend.position = "bottom",
  )

```


## Годовые доли пациентов, попавших в ТО (4.5 часа) в группе 1


```{r}
data_prepared <- all_data_group1 %>%
  # метка для объединенного графика
  mutate(hosp_combined = "Суммарно") %>%
  # общее количество летальных исходов и пролеченных случаев по году и центру
  group_by(hosp, year) %>%
  summarise(
    total_ii_window = sum(ИИ_Терапевтическое_Окно, na.rm = TRUE),  
    total_gi_window = sum(ГИ_Терапевтическое_Окно, na.rm = TRUE), 
    total_ii_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),
    total_gi_cases = sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # процент для каждого госпиталя
  mutate(
    ii_проц = total_ii_window / total_ii_cases * 100,
    gi_проц = total_gi_window / total_gi_cases * 100
  ) %>%
  # суммарный график
  bind_rows(
    all_data_group1 %>%
      group_by(year) %>%
      summarise(
        total_ii_window = sum(ИИ_Терапевтическое_Окно, na.rm = TRUE),  
        total_gi_window = sum(ГИ_Терапевтическое_Окно, na.rm = TRUE), 
        total_ii_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),
        total_gi_cases = sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        hosp = "Суммарно",  
        ii_проц = total_ii_window / total_ii_cases * 100,
        gi_проц = total_gi_window / total_gi_cases * 100
      )
  )


data_long <- data_prepared %>%
  select(hosp, year, ii_проц, gi_проц) %>%
  pivot_longer(
    cols = c(ii_проц, gi_проц),
    names_to = "type",
    values_to = "percentage"
  )

ggplot(data_long, aes(x = year, y = percentage, color = type)) +
  geom_line() +  
  geom_point() +  
  facet_wrap(vars(hosp), scales = "free") +  # Facet by hospital
  scale_color_manual(
    values = c("ii_проц" = "#1f77b4", "gi_проц" = "darkred"),
    labels = c("ii_проц" = "ИИ", "gi_проц" = "ГИ"),
    name = "Тип инсульта"
  ) +
  labs(
    title = "Доли пациентов, попавших в ТО (4.5 часа) в группе 1",
    x = "",
    y = "%"
  ) +
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) +  
  theme_custom +
  theme(
    legend.position = "bottom"
  )
```


## Quarterly Therapeutic Windows


total_window = sum(ИИ_Терапевтическое_Окно, ГИ_Терапевтическое_Окно, na.rm = TRUE),  
total_cases = sum(ИИ_Ишемический_Инсульт, ГИ_Геморрагический_Инсульт, na.rm = TRUE)


```{r, fig.width = 12, fig.height = 4}
library(lubridate)
data_prepared <- all_data_group1 %>%
  # Create year_month column
  mutate(year_quarter = as.Date(paste0(year, "-", (quarter(month) - 1) * 3 + 1, "-01")),
         hosp_combined = "Total in group 1") %>%
  # Group by hospital and year_month
  group_by(hosp, year_quarter) %>%
  summarise(
    total_window = sum(ИИ_Терапевтическое_Окно, ГИ_Терапевтическое_Окно, na.rm = TRUE),  
    total_cases = sum(ИИ_Ишемический_Инсульт, ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Calculate percentages for each hospital
  mutate(
    проц = total_window / total_cases * 100
  ) %>%
  # Add combined data for "Суммарно"
  bind_rows(
    all_data_group1 %>%
      mutate(year_quarter = as.Date(paste0(year, "-", (quarter(month) - 1) * 3 + 1, "-01"))) %>%
      group_by(year_quarter) %>%
      summarise(
        total_window = sum(ИИ_Терапевтическое_Окно, ГИ_Терапевтическое_Окно, na.rm = TRUE),  
        total_cases = sum(ИИ_Ишемический_Инсульт, ГИ_Геморрагический_Инсульт, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        hosp = "Total in group 1",
        проц = total_window / total_cases * 100
      )
  )

# Pivot to long format
data_long <- data_prepared %>%
  select(hosp, year_quarter, проц) %>%
  pivot_longer(
    cols = c(проц),
    names_to = "type",
    values_to = "percentage"
  )

# Visualization
ggplot(data_long, aes(x = year_quarter, y = percentage)) +
  geom_line() +  
  geom_point() + 
  geom_smooth(method = "loess", span = 0.3, se = TRUE) +
  facet_wrap(vars(hosp), scales = "free") +  
  labs(
    title = "Quarterly percentages of patients in the therapeutic window in group 1",
    x = "",
    y = "% of total IS and HI cases"
  ) +
  
  scale_x_date(date_breaks = "3 months", date_labels = "%Y-Q%q") +
  theme_custom +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 4)
  )


#ggplot2::ggsave("images/therapeutic_window_group1.png", width = 12, height = 4)

```

Reorganised 

```{r}

library(lubridate)
data_prepared <- all_data_group1 %>%
  # Create year_month column
  mutate(year_quarter = as.Date(paste0(year, "-", (quarter(month) - 1) * 3 + 1, "-01"))) %>%
  # Group by hospital and year_month
  group_by(hosp, year_quarter) %>%
  summarise(
    total_window = sum(ИИ_Терапевтическое_Окно, ГИ_Терапевтическое_Окно, na.rm = TRUE),  
    total_cases = sum(ИИ_Ишемический_Инсульт, ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Calculate percentages for each hospital
  mutate(
    проц = total_window / total_cases * 100
  ) 

# Pivot to long format
data_long <- data_prepared %>%
  select(hosp, year_quarter, проц) %>%
  pivot_longer(
    cols = c(проц),
    names_to = "type",
    values_to = "percentage"
  )


by_hospital <- ggplot(data_long, aes(x = year_quarter, y = percentage)) +
    geom_line() +  
    geom_point() + 
    geom_smooth(method = "loess", span = 0.3, se = TRUE) +
    facet_wrap(vars(hosp), scales = "free") +  
    labs(
      title = "Quarterly percentages of patients in the therapeutic window in group 1",
      x = "",
      y = "% of total IS and HI cases"
    ) +
    scale_x_date(
      date_breaks = "3 months",  # Breaks every 3 months
      date_labels = "%Y-%m"     # Standard date format (e.g., 2023-01)
    ) +
    theme_custom +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 45, hjust = 1, size = 4)
    )



by_hospital

```




```{r, fig.width = 12, fig.height = 4}}


data_prepared <- all_data_group1 %>%
  mutate(
    year_quarter = as.Date(paste0(year, "-", (quarter(month) - 1) * 3 + 1, "-01")) 
  ) %>%
  group_by(year_quarter) %>%
  summarise(
    total_window = sum(ИИ_Терапевтическое_Окно, ГИ_Терапевтическое_Окно, na.rm = TRUE),  
    total_cases = sum(ИИ_Ишемический_Инсульт, ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    проц = total_window / total_cases * 100
  )

# Pivot to long format for plotting
data_long <- data_prepared %>%
  select(year_quarter, проц) %>%
  pivot_longer(
    cols = c(проц),
    names_to = "type",
    values_to = "percentage"
  )


total <- ggplot(data_long, aes(x = year_quarter, y = percentage)) +
  geom_line() +
  geom_point() +
  geom_smooth(method = "loess", span = 0.3, se = TRUE) +
  labs(
    title = "Total group 1",
    x = "Date",
    y = "% of total IS and HI cases"
  ) +
  scale_x_date(
    date_breaks = "3 months", 
    date_labels = "%Y-%m"     
  ) +
  theme_custom +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8)
  )

total
```

## Monthly 


```{r}
data_prepared <- all_data_group1 %>%
  mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
  # Group by hospital and year_month
  group_by(hosp, year_month) %>%
  summarise(
    total_window = sum(ИИ_Терапевтическое_Окно, ГИ_Терапевтическое_Окно, na.rm = TRUE),  
    total_cases = sum(ИИ_Ишемический_Инсульт, ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Calculate percentages for each hospital
  mutate(
    проц = total_window / total_cases * 100
  ) 

# Pivot to long format
data_long <- data_prepared %>%
  select(hosp, year_month, проц) %>%
  pivot_longer(
    cols = c(проц),
    names_to = "type",
    values_to = "percentage"
  )


by_hospital <- ggplot(data_long, aes(x = year_month, y = percentage)) +
    geom_line(size = 0.5) +  
    geom_point(size = 0.8) + 
    geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "#1f77b4") +
    facet_wrap(vars(hosp), scales = "free") +  
    labs(
      title = "Monthly rates of patients in the therapeutic window in group 1",
      x = "",
      y = "% of total IS and HI cases"
    ) +
    scale_x_date(
      date_breaks = "3 months",  # Breaks every 3 months
      date_labels = "%Y-%m"     # Standard date format (e.g., 2023-01)
    ) +
    theme_custom +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 90, hjust = 1, size = 4)
    )

by_hospital

ggplot2::ggsave("images/by_hosp_monthly_therapeutic_window_group1.png", by_hospital)
```
```{r}
data_prepared <- all_data_group1 %>%
  mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
  group_by(year_month) %>%
  summarise(
    total_window = sum(ИИ_Терапевтическое_Окно, ГИ_Терапевтическое_Окно, na.rm = TRUE),  
    total_cases = sum(ИИ_Ишемический_Инсульт, ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    проц = total_window / total_cases * 100
  )

# Pivot to long format for plotting
data_long <- data_prepared %>%
  select(year_month, проц) %>%
  pivot_longer(
    cols = c(проц),
    names_to = "type",
    values_to = "percentage"
  )


total <- ggplot(data_long, aes(x = year_month, y = percentage)) +
  geom_line() +
  geom_point() +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "darkred") +
  labs(
    title = "Total group 1",
    x = "",
    y = "% of total IS and HI cases"
  ) +
  scale_x_date(
    date_breaks = "3 months", 
    date_labels = "%Y-%m"     
  ) +
  theme_custom +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8)
  )

total

ggsave("images/total_monthly_therapeutic_window_group1.png", total)
```



## Динамика пациентов, попавших в ТО (4.5 часа) по месяцам в группе 1


```{r, fig.width = 12, fig.height = 3}
data_prepared <- all_data_group1 %>%
    mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
    group_by(year_month) %>%
    summarise(
    total_ii_window = sum(ИИ_Терапевтическое_Окно, na.rm = TRUE),  
    total_gi_window = sum(ГИ_Терапевтическое_Окно, na.rm = TRUE), 
    total_ii_cases = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE),
    total_gi_cases = sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    ii_проц = total_ii_window / total_ii_cases * 100,
    gi_проц = total_gi_window / total_gi_cases * 100
  )



data_long <- data_prepared %>%
  select(year_month, ii_проц, gi_проц) %>%
  pivot_longer(
    cols = c(ii_проц, gi_проц),
    names_to = "type",
    values_to = "percentage"
  )

ggplot(data_long, aes(x = year_month, y = percentage, color = type)) +
  geom_line() +  
  geom_point() +
  geom_smooth(method = "loess", span = 0.3, se = TRUE) +
  scale_color_manual(
    values = c("ii_проц" = "#1f77b4", "gi_проц" = "darkred"),
    labels = c("ii_проц" = "ИИ", "gi_проц" = "ГИ"),
    name = "Тип инсульта"
  ) +
  labs(
    title = "Месячные доли пациентов, попавших в ТО (4.5 часа) в группе 1",
    x = "",
    y = "% от всех случаев"
  ) +
    scale_x_date(
    date_breaks = "3 month",      
    date_labels = "%Y-%m"          
  ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 8),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
      legend.position = "bottom")
  
```
# Выписка 

## Выписано / Госпализировано (%) - общегородской monthly trend line

% от суммы Госпитализированы_с_ОНМК + Внутрибольничные_ОНМК

```{r, fig.width = 12, fig.height = 3}
data_prepared <- database_summarized_month %>%
    mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
    group_by(year_month) %>%
  summarise(
    total_discharged = sum(Выписаны_Всего, na.rm = TRUE),
    total_hospitalized = sum(Госпитализированы_с_ОНМК, Внутрибольничные_ОНМК, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    discharged_проц = total_discharged / (total_discharged + total_hospitalized) * 100,
  ) %>%
  pivot_longer(
    cols = c(discharged_проц),
    names_to = "type",
    values_to = "percentage"
  )


ggplot(data_prepared, aes(x = year_month, y = percentage)) +
  geom_line() +  
  geom_point() +
  #geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "blue") +
  labs(
    title = "Общегородские месячные доли выписанных пациентов",
    x = "",
    y = "% от госпиталированных+внутр"
  ) +
  scale_x_date(
    date_breaks = "2 month",      
    date_labels = "%Y-%m"          
  ) +
    theme_custom +
    theme(
      plot.title = element_text(size = 12),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
      legend.position = "bottom")
```
## Выписано / Госпализировано (%) - monthly trend line для каждого РСЦ в группе 1

```{r, fig.width = 12, fig.height = 4}

data_prepared <- all_data_group1 %>%
  mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
  group_by(hosp, year_month) %>%
  summarise(
    total_discharged = sum(Выписаны_Всего, na.rm = TRUE),
    total_hospitalized = sum(Госпитализированы_с_ОНМК, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    discharged_проц = total_discharged / total_hospitalized * 100
  ) %>%

  bind_rows(
    all_data_group1 %>%
      mutate(year_month = anytime::anydate(paste0(year, paste0(ifelse(month < 10, paste0("0", month), month), "01"), sep = "-"))) %>%
      group_by(year_month) %>%
      summarise(
        total_discharged = sum(Выписаны_Всего, na.rm = TRUE),
        total_hospitalized = sum(Госпитализированы_с_ОНМК, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        hosp = "Total group 1",
        discharged_проц = total_discharged / total_hospitalized * 100
      )
  )


ggplot(data_prepared, aes(x = year_month, y = discharged_проц, color = hosp)) +
  geom_line(color = "black") +
  geom_point(color = "black", size = 0.5) +
  geom_smooth(method = "loess", span = 0.3, se = TRUE, color = "darkgreen") +
  facet_wrap(~ hosp, scales = "free") +  # Facet by hospital
  labs(
    title = "Monthly trend of discharged/hospitalized patients (%) in group 1",
    x = "",
    y = "% hospitalized patients"
  ) +
  scale_x_date(
    date_breaks = "3 month",      
    date_labels = "%Y-%m"          
  ) +
  theme_custom +
  theme(
    axis.text.x = element_text(size = 5)
  )

ggplot2::ggsave("images/discharge_group1.png", width = 12, height = 4)

```

# Корреляционный анализ между изменениями в летальных исходах и индикаторами


## Correlation matrix


```{r}

library(ggplot2)
library(reshape2)
library(corrplot)


data_prepared <- all_data_group1 %>%
  mutate(year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))) %>%
  group_by(year_month) %>%
  summarise(
    lethal_outcomes_perc = sum(Летальные_Исходы, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    ishemic_stroke_perc = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    gem_stroke_perc = sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    age60_perc = sum(Старше_60_лет, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    severeNIHSSS_prec = sum(NIHSS_Больше_21, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    ii_therapeutic_window_perc = sum(ИИ_Терапевтическое_Окно, na.rm = TRUE) / sum(ИИ_Ишемический_Инсульт, na.rm = TRUE) * 100,
    gi_therapeutic_window_perc = sum(ГИ_Терапевтическое_Окно, na.rm = TRUE) / sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE) * 100,
    thromb_perc = sum(Тромболизис, na.rm = TRUE) / sum(ИИ_Ишемический_Инсульт, na.rm = TRUE) * 100,
    total_load = sum(Суммарная_Загрузка_ОНМК, na.rm = TRUE),
    
    .groups = "drop"
  )


time_series_data <- data_prepared %>%
  select(-year_month)  # Only numeric time series columns


cor_matrix <- cor(time_series_data, use = "pairwise.complete.obs", method = "pearson")


cor_melted <- melt(cor_matrix)  
cor_melted_plot <- ggplot(cor_melted, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +  # Add values
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1, 1), space = "Lab", name = "Pearson r") +
  labs(title = "Correlation matrix for group 1",
       x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggsave("images/correlation_matrix.png", cor_melted_plot, width = 8, height = 6)



```
## Correlation matrix for each hosp

```{r}
library(ggplot2)
library(reshape2)
library(dplyr)
library(anytime)

# Data preparation
data_prepared <- all_data_group1 %>%
  mutate(
    year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))
  ) %>%
  group_by(hosp, year_month) %>%
  summarise(
    lethal_outcomes_perc = sum(Летальные_Исходы, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    ishemic_stroke_perc = sum(ИИ_Ишемический_Инсульт, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    gem_stroke_perc = sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    age60_perc = sum(Старше_60_лет, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    severeNIHSSS_perc = sum(NIHSS_Больше_21, na.rm = TRUE) / sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE) * 100,
    ii_therapeutic_window_perc = sum(ИИ_Терапевтическое_Окно, na.rm = TRUE) / sum(ИИ_Ишемический_Инсульт, na.rm = TRUE) * 100,
    gi_therapeutic_window_perc = sum(ГИ_Терапевтическое_Окно, na.rm = TRUE) / sum(ГИ_Геморрагический_Инсульт, na.rm = TRUE) * 100,
    thromb_perc = sum(Тромболизис, na.rm = TRUE) / sum(ИИ_Ишемический_Инсульт, na.rm = TRUE) * 100,
    total_load = sum(Суммарная_Загрузка_ОНМК, na.rm = TRUE),
    .groups = "drop"
  )

# Function to calculate and plot the upper triangular correlation matrix
plot_upper_triangle <- function(hosp_name, data) {
  # Filter data for the hospital
  hospital_data <- data %>% filter(hosp == hosp_name) %>% select(-hosp, -year_month)
  
  # Calculate correlation matrix
  cor_matrix <- cor(hospital_data, use = "pairwise.complete.obs", method = "pearson")
  
  # Mask the lower triangle
  cor_matrix[lower.tri(cor_matrix, diag = FALSE)] <- NA
  
  # Melt the correlation matrix
  cor_melted <- melt(cor_matrix, na.rm = TRUE)  # Remove NA entries
  
  # Plot
  ggplot(cor_melted, aes(Var1, Var2, fill = value)) +
    geom_tile(color = "white") +
    geom_text(aes(label = round(value, 2)), color = "black", size = 4) +  # Add values
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                         midpoint = 0, limit = c(-1, 1), space = "Lab", name = "Pearson r") +
    labs(
      title = paste("Correlation matrix for", hosp_name),
      x = "", y = ""
    ) +
    theme_custom +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# Create correlation matrix plots for each hospital
hospitals <- unique(data_prepared$hosp)
plots <- lapply(hospitals, function(hosp_name) {
  plot_upper_triangle(hosp_name, data_prepared)
})

# Display the first hospital's plot as an example
plots[[2]]

ggplot2::ggsave("images/correlation_matrix_hosp2.png", plots[[2]])

```

## Lagged Correlation Between Scaled Hospital Load and Mortality Rate

Суммарная_Загрузка_ОНМК / 10

```{r}
library(ggplot2)
library(dplyr)
library(patchwork)


data_prepared <- all_data_group1 %>%
  mutate(
    year_month = anytime::anydate(paste0(year, "-", sprintf("%02d", month), "-01"))
  ) %>%
  group_by(year_month) %>%
  summarise(
    total_lethal = sum(Летальные_Исходы, na.rm = TRUE),
    total_cases = sum(Пролечены_с_ОНМК_Всего, na.rm = TRUE),
    sum_load = sum(Суммарная_Загрузка_ОНМК, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    lethal_outcomes_perc = total_lethal / total_cases * 100,  # % of lethal outcomes
    sum_load_scaled = sum_load / 10  # Scale down the hospital load
  ) %>%
  select(year_month, lethal_outcomes_perc, sum_load_scaled)



# Dynamically set max lag
total_months <- length(unique(data_prepared$year_month)) - 1
lags <- seq(0, total_months, by = 1)

# Calculate Lagged Correlations
cor_results <- lapply(lags, function(lag) {
  lagged_series <- c(rep(NA, lag), data_prepared$sum_load_scaled[1:(nrow(data_prepared) - lag)])
  
  valid_indices <- complete.cases(data_prepared$lethal_outcomes_perc, lagged_series)
  
  if (sum(valid_indices) >= 3) {
    test <- cor.test(
      data_prepared$lethal_outcomes_perc[valid_indices],
      lagged_series[valid_indices],
      use = "complete.obs"
    )
    list(
      Lag = lag,
      Correlation = test$estimate,
      P_Value = test$p.value
    )
  } else {
    list(
      Lag = lag,
      Correlation = NA,
      P_Value = NA
    )
  }
})

cor_data <- do.call(rbind, lapply(cor_results, as.data.frame))

# Add significance
cor_data <- cor_data %>%
  mutate(Significant = ifelse(P_Value < 0.05 & !is.na(P_Value), "Significant", "Not Significant"))



top_plot <- ggplot(cor_data, aes(x = Lag, y = Correlation, fill = Significant)) +
  geom_bar(stat = "identity", color = "black", alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  scale_fill_manual(values = c("Significant" = "grey30", "Not Significant" = "lightgray")) +
  labs(
    title = "Lagged Correlation Between Scaled Hospital Load and Mortality Rate",
    x = "Time Lag (Months)",
    y = "r"
  ) +
  theme_minimal() +
  theme(legend.position = "none")



bottom_plot <- ggplot(data_prepared, aes(x = year_month)) +
  geom_line(aes(y = sum_load_scaled, color = "Hospital Load (Scaled)")) +
  geom_point(aes(y = sum_load_scaled, color = "Hospital Load (Scaled)"), size = 1) +
  geom_line(aes(y = lethal_outcomes_perc, color = "Mortality Rate")) +
  geom_point(aes(y = lethal_outcomes_perc, color = "Mortality Rate"), size = 1) +
  scale_y_continuous(
    name = "Hospital Load (Scaled, x10)",
    sec.axis = sec_axis(~ ., name = "Mortality Rate (%)")
  ) +
  scale_color_manual(
    values = c("Hospital Load (Scaled)" = "#1f77b4", "Mortality Rate" = "darkred"),
    name = "Series"
  ) +
  labs(
    title = "Hospital Load (Scaled) and Mortality Rate Over Time",
    x = "Date/Time"
  ) +
  scale_x_date(
    date_breaks = "2 months",
    date_labels = "%Y-%m"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_text(color = "#1f77b4"),
    axis.title.y.right = element_text(color = "darkred"),
    legend.position = "bottom"
  )


combined_plot <- top_plot / bottom_plot
print(combined_plot)


```






```{r}
colnames(database_summarized_month)
```
Еще сделай барплоты по шкале ривермид в соотношении c выписаны всего

"Выписаны_Всего"                    
[45] "Ривермид_1_Балл"                    "Ривермид_2_4_Балла"                
[47] "Ривермид_5_8_Баллов"                "Ривермид_9_Баллов"  



```{r}

data_prepared <- all_data_group1 %>%

  mutate(hosp_combined = "Суммарно") %>%
  group_by(hosp, year) %>%
  summarise(
    total_discharged = sum(Выписаны_Всего, na.rm = TRUE),
    total_rivermid_1 = sum(Ривермид_1_Балл, na.rm = TRUE),
    total_rivermid_2_4 = sum(Ривермид_2_4_Балла, na.rm = TRUE),
    total_rivermid_5_8 = sum(Ривермид_5_8_Баллов, na.rm = TRUE),
    total_rivermid_9 = sum(Ривермид_9_Баллов, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    rivermid_1_perc = total_rivermid_1 / total_discharged * 100,
    rivermid_2_4_perc = total_rivermid_2_4 / total_discharged * 100,
    rivermid_5_8_perc = total_rivermid_5_8 / total_discharged * 100,
    rivermid_9_perc = total_rivermid_9 / total_discharged * 100
  ) %>%

  bind_rows(
    all_data_group1 %>%
      group_by(year) %>%
      summarise(
        total_discharged = sum(Выписаны_Всего, na.rm = TRUE),
        total_rivermid_1 = sum(Ривермид_1_Балл, na.rm = TRUE),
        total_rivermid_2_4 = sum(Ривермид_2_4_Балла, na.rm = TRUE),
        total_rivermid_5_8 = sum(Ривермид_5_8_Баллов, na.rm = TRUE),
        total_rivermid_9 = sum(Ривермид_9_Баллов, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(
        hosp = "Суммарно",
        rivermid_1_perc = total_rivermid_1 / total_discharged * 100,
        rivermid_2_4_perc = total_rivermid_2_4 / total_discharged * 100,
        rivermid_5_8_perc = total_rivermid_5_8 / total_discharged * 100,
        rivermid_9_perc = total_rivermid_9 / total_discharged * 100
      )
  )


data_long <- data_prepared %>%
  select(hosp, year, rivermid_1_perc, rivermid_2_4_perc, rivermid_5_8_perc, rivermid_9_perc) %>%
  pivot_longer(
    cols = c(rivermid_1_perc, rivermid_2_4_perc, rivermid_5_8_perc, rivermid_9_perc),
    names_to = "type",
    values_to = "percentage"
  )


ggplot(data_long, aes(x = year, y = percentage, fill = type)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_wrap(vars(hosp), scales = "free") +  # Facet for each hospital and combined
  scale_fill_manual(
    values = c("rivermid_1_perc" = "#1f77b4", 
               "rivermid_2_4_perc" = "darkred", 
               "rivermid_5_8_perc" = "darkgrey",
               "rivermid_9_perc" = "darkgreen"),
    labels = c("rivermid_1_perc" = "1 балл", 
               "rivermid_2_4_perc" = "2-4 балла", 
               "rivermid_5_8_perc" = "5-8 баллов",
               "rivermid_9_perc" = "9 баллов"),
    name = "Ривермид"
  ) +
  labs(
    title = "Выписанные пациенты по шкале Ривермид в группе 1",
    x = "",
    y = ""
  ) +
  scale_x_continuous(breaks = seq(2017, 2024, by = 1)) +  
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```





```{r}
Sys.setlocale("LC_CTYPE", "English_United Kingdom.utf8")



```

