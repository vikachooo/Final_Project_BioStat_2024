---
title: "Untitled"
author: "Victoria Zaitceva"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("visdat")
library(visdat)
```


```{r}
# get sum of missing values for each column

missing_values <- colSums(is.na(cleaned_data))
```

Список цветных переменных:

Направлено.всего.с.диагнозом.ОНМК 
Не.подтвержден.диагноз.ОНМК 
Госпитализировано.с.подтвержденным.диагнозом.ОНМК
Пролечено.с.ОНМК.Всего....закрыто.и.б..не.считая.переводов.
Внутригоспитальные.ОНМК.Всего..находились.на.лечении.в.стационаре.с.другой.патологией.
с.ИИ..ишемический.инсульт.
с.ТИА..транзиторно.ишемическая.атака. 
с.ГИ..геморрагический.инсульт..всего 
X..ВМК.ВЖК..внутримозговое.внутрижелудочковое.кровоизлияние..на.фоне.ГБ 
X..САК..субарахноидальное.кровоизлияние..при.неподтвержденной.аневризме 
X..АВМ..кровоизлияние.при.артерио.венозной.мальформации. 
X..САК.при.аневризме.мозговой.артерии
Поступили.в..терапевтическое.окно.....4.5ч. 
из.них.ИИ 
из.них.ГИ
Переведены.из.ПСО.в.РСЦ.для.хирургического.лечения 
X..ГИ.в.срок.до.48.ч..с.целью.краниотомии. 
X..ИИ.в.срок.до.12.ч..с.целью.ТЭ.или.стентирования.церебральных.артерий. 
X..ИИ.в.срок.до.2.нед..с.целью.хирургической.реваскуляризации.сосудов.шеи...КЭАЭ..КАС..ЭИКМА..АС.АП.ПА. 
Направлены.на.реабилитацию 
X..в.другой.стационар..II.этап.реабилитации. 
X..в.санаторий..III.этап.реабилитации. 
X..на.паллиативное.лечение 
X..на.койки..сестринского.ухода. 
  X..на.амбулаторное.лечение..дневной.стационар.поликлиники. 
X..в.реабилитационное.отделение.собственного.стационара..II.этап. 
Характеристика.госпитализированных.больных 
X..до.45.лет 
X..45.60.лет 
X..старше.60.лет 

тяжесть.по.NIHSS.до.начала.лечения 
X..менее.4.баллов 
X..более.21.балла 
X..от.5.до.20.баллов

Тромболизис 
Тромбэкстракция   
Комбинированная.реперфузия..ТЛТ...ТЭ...до.12.часов.
Реваскуляризирующие.операции.в.остром.периоде..всего

При.ГИ..всего

Летальные..исходы..ЛИ..всего
всего.ЛИ.в.1.сутки.поступления 

Выписано.из.стационара.всего 
из.них.по.шкале.Ривермид....1.балл 
из.них.по.шкале.Ривермид..от.2.до.4.баллов 
из.них.по.шкале.Ривермид..от.5.до.8.баллов 
из.них.по.шкале.Ривермид...9.баллов 



```{r}

columns_of_interest <- c(
  "week_end",
  "WEEK",
  "type",
  "hosp",
  "year",
  "Направлено.всего.с.диагнозом.ОНМК",
  "Не.подтвержден.диагноз.ОНМК",
  "Госпитализировано.с.подтвержденным.диагнозом.ОНМК",
  "Пролечено.с.ОНМК.Всего....закрыто.и.б..не.считая.переводов.",
  "Внутригоспитальные.ОНМК.Всего..находились.на.лечении.в.стационаре.с.другой.патологией.",
  "с.ИИ..ишемический.инсульт.",
  "с.ТИА..транзиторно.ишемическая.атака.",
  "с.ГИ..геморрагический.инсульт..всего",
  "X..ВМК.ВЖК..внутримозговое.внутрижелудочковое.кровоизлияние..на.фоне.ГБ",
  "X..САК..субарахноидальное.кровоизлияние..при.неподтвержденной.аневризме",
  "X..АВМ..кровоизлияние.при.артерио.венозной.мальформации.",
  "X..САК.при.аневризме.мозговой.артерии",
  "Поступили.в..терапевтическое.окно.....4.5ч.",
  "из.них.ИИ",
  "из.них.ГИ",
  "Переведены.из.ПСО.в.РСЦ.для.хирургического.лечения",
  "X..ГИ.в.срок.до.48.ч..с.целью.краниотомии.",
  "X..ИИ.в.срок.до.12.ч..с.целью.ТЭ.или.стентирования.церебральных.артерий.",
  "X..ИИ.в.срок.до.2.нед..с.целью.хирургической.реваскуляризации.сосудов.шеи...КЭАЭ..КАС..ЭИКМА..АС.АП.ПА.",
  "Направлены.на.реабилитацию",
  "X..в.другой.стационар..II.этап.реабилитации.",
  "X..в.санаторий..III.этап.реабилитации.",
  "X..на.паллиативное.лечение",
  "X..на.койки..сестринского.ухода.",
  "X..на.амбулаторное.лечение..дневной.стационар.поликлиники.",
  "X..в.реабилитационное.отделение.собственного.стационара..II.этап.",
  "X..до.45.лет",
  "X..45.60.лет",
  "X..старше.60.лет",
  "X..менее.4.баллов",
  "X..более.21.балла",
  "X..от.5.до.20.баллов",
  "Тромболизис",
  "Тромбэкстракция",
  "Комбинированная.реперфузия..ТЛТ...ТЭ...до.12.часов.",
  "Реваскуляризирующие.операции.в.остром.периоде..всего",
  "При.ГИ..всего",
  "Летальные..исходы..ЛИ..всего",
  "всего.ЛИ.в.1.сутки.поступления",
  "Выписано.из.стационара.всего",
  "из.них.по.шкале.Ривермид....1.балл",
  "из.них.по.шкале.Ривермид..от.2.до.4.баллов",
  "из.них.по.шкале.Ривермид..от.5.до.8.баллов",
  "из.них.по.шкале.Ривермид...9.баллов"
)



cleaned_data_selected <- cleaned_data[, columns_of_interest]



rename_columns <- c(
  "Направлено.всего.с.диагнозом.ОНМК" = "Всего_с_ОНМК",
  "Не.подтвержден.диагноз.ОНМК" = "Не_подтвержден_ОНМК",
  "Госпитализировано.с.подтвержденным.диагнозом.ОНМК" = "Госпитализированы_с_ОНМК",
  "Пролечено.с.ОНМК.Всего....закрыто.и.б..не.считая.переводов." = "Пролечены_с_ОНМК_Всего",
  "Внутригоспитальные.ОНМК.Всего..находились.на.лечении.в.стационаре.с.другой.патологией." = "Внутрибольничные_ОНМК",
  "с.ИИ..ишемический.инсульт." = "ИИ_Ишемический_Инсульт",
  "с.ТИА..транзиторно.ишемическая.атака." = "ТИА_Транзиторная_Ишемическая_Атака",
  "с.ГИ..геморрагический.инсульт..всего" = "ГИ_Геморрагический_Инсульт",
  "X..ВМК.ВЖК..внутримозговое.внутрижелудочковое.кровоизлияние..на.фоне.ГБ" = "ВМК_ВЖК",
  "X..САК..субарахноидальное.кровоизлияние..при.неподтвержденной.аневризме" = "САК_Неподтвержденная_Аневризма",
  "X..АВМ..кровоизлияние.при.артерио.венозной.мальформации." = "Кровоизлияние_АВМ",
  "X..САК.при.аневризме.мозговой.артерии" = "САК_Аневризма",
  "Поступили.в..терапевтическое.окно.....4.5ч." = "Терапевтическое_Окно_4_5ч",
  "из.них.ИИ" = "ИИ_Терапевтическое_Окно",
  "из.них.ГИ" = "ГИ_Терапевтическое_Окно",
  "Переведены.из.ПСО.в.РСЦ.для.хирургического.лечения" = "Переведены_ПСО_РСЦ",
  "X..ГИ.в.срок.до.48.ч..с.целью.краниотомии." = "ГИ_Переведены_до_48ч",
  "X..ИИ.в.срок.до.12.ч..с.целью.ТЭ.или.стентирования.церебральных.артерий." = "ИИ_Переведены_до_12ч",
  "X..ИИ.в.срок.до.2.нед..с.целью.хирургической.реваскуляризации.сосудов.шеи...КЭАЭ..КАС..ЭИКМА..АС.АП.ПА." = "ИИ_Переведены_до_2_недель",
  "Направлены.на.реабилитацию" = "Направлены_на_Реабилитацию",
  "X..в.другой.стационар..II.этап.реабилитации." = "II_Этап_Реабилитация",
  "X..в.санаторий..III.этап.реабилитации." = "III_Этап_Реабилитация",
  "X..на.паллиативное.лечение" = "Паллиативное_Лечение",
  "X..на.койки..сестринского.ухода." = "Сестринский_Уход",
  "X..на.амбулаторное.лечение..дневной.стационар.поликлиники." = "Амбулаторное_Лечение",
  "X..в.реабилитационное.отделение.собственного.стационара..II.этап." = "Собственная_Реабилитация_II_Этап",
  "X..до.45.лет" = "Младше_45_лет",
  "X..45.60.лет" = "От_45_до_60_лет",
  "X..старше.60.лет" = "Старше_60_лет",
  "X..менее.4.баллов" = "NIHSS_Меньше_4",
  "X..более.21.балла" = "NIHSS_Больше_21",
  "X..от.5.до.20.баллов" = "NIHSS_5_20",
  "Тромболизис" = "Тромболизис",
  "Тромбэкстракция" = "Тромбэкстракция",
  "Комбинированная.реперфузия..ТЛТ...ТЭ...до.12.часов." = "Комбинированная_Реперфузия",
  "Реваскуляризирующие.операции.в.остром.периоде..всего" = "Реваскуляризация_Острый_Период",
  "При.ГИ..всего" = "ГИ_Всего",
  "Летальные..исходы..ЛИ..всего" = "Летальные_Исходы",
  "всего.ЛИ.в.1.сутки.поступления" = "Летальные_Исходы_1_Сутки",
  "Выписано.из.стационара.всего" = "Выписаны_Всего",
  "из.них.по.шкале.Ривермид....1.балл" = "Ривермид_1_Балл",
  "из.них.по.шкале.Ривермид..от.2.до.4.баллов" = "Ривермид_2_4_Балла",
  "из.них.по.шкале.Ривермид..от.5.до.8.баллов" = "Ривермид_5_8_Баллов",
  "из.них.по.шкале.Ривермид...9.баллов" = "Ривермид_9_Баллов"
)



cleaned_data_selected <- cleaned_data_selected |> 
  rename_with(~ ifelse(!is.na(rename_columns[.x]), rename_columns[.x], .x))


```





```{r}
vis_dat(cleaned_data_selected[,-c(1:5)])
```




```{r}
#if week_end has 3 characters, add 0 to the beginning - to format it as ddmmYYYY


cleaned_data_selected <- cleaned_data_selected |>
  mutate(week_end = if_else(str_length(week_end) == 3, paste0("0", week_end), week_end),
         date = paste0(week_end, year), 
         date = as.Date(date, format = "%d%m%Y")) |>
  select(date, year, everything()) |>
  select(-week_end, -WEEK)


# numerate each week for each hospital within each year, based on date

cleaned_data_selected <- cleaned_data_selected |>
  group_by(hosp, type, year) |>
  arrange(date) |>
  mutate(week = row_number()) |>
  ungroup()

cleaned_data_selected <- cleaned_data_selected |>
  select(week, date, everything())

```


Посмотреть на недели с пропущенными значенями


```{r}

missing_weeks <- apply(cleaned_data_selected[, 6:49], 1, function(x) all(is.na(x)))

na_row_indices <- which(missing_weeks)

missing_weeks <- cleaned_data_selected[na_row_indices, ]





missing_weeks |>
  group_by(week) |>
  summarise(missing_weeks_for_this_weak_number = n()) |>
  arrange(week)

# 53 weeks max a year

missing_weeks |>
  group_by(week) |>
  summarise(missing_weeks_for_this_weak_number = n()) |>
  ggplot(aes(x = as.factor(week), y = missing_weeks_for_this_weak_number)) +
  geom_col() +
  labs(title = "Какие недели пропущены чаще всего", x = "неделя", y = "сколько раз пропущена (по всем центрам и годам") +
  geom_text(aes(label = missing_weeks_for_this_weak_number), vjust = -0.5) +
  theme_minimal()

```


Если в отдельном центре в конкретную неделю хотя бы одна переменная заполнена, то все остальные переменные с пропущенными значенями можно заменить на 0.


```{r}
ncol(cleaned_data_selected)


cols_to_check <- names(cleaned_data_selected)[6:49]



cleaned_data_selected1 <- cleaned_data_selected %>%
  group_by(hosp, week) %>%
  mutate(
    any_non_na_cols = if_any(all_of(cols_to_check), ~ !is.na(.x)),
    across(all_of(cols_to_check), ~ if_else(any_non_na_cols, replace_na(.x, 0), .x))
  ) %>%
  ungroup()


```





```{r}
vis_dat(cleaned_data_selected1[,-c(1:5,50)])
```


Теперь надо объединить недели в месяца, чтобы все недельные значения были суммированы в месячные. 


```{r}



cols_to_sum <- names(cleaned_data_selected1)[6:49]

cleaned_data_selected2 <- cleaned_data_selected1 %>%
  mutate(
    # Создаём столбец month, группируя недели по 4, но не превышая 12
    month = pmin(((week - 1) %/% 4) + 1, 12),
    # Преобразуем первые 5 столбцов в факторы, чтобы они не участвовали в суммировании
    across(1:5, ~ as.factor(.x))
  ) %>%
  group_by(hosp, type, year, month) %>%
  summarize(
    across(
      all_of(cols_to_sum),
      ~ if (all(is.na(.x))) NA_real_ else sum(.x, na.rm = TRUE)
    ),
    .groups = "drop"
  )


```




```{r}
vis_dat(cleaned_data_selected2[,-c(1:4)])
```


Просуммируем отделения для каждого центра, каждой недели и каждого года.


```{r}
cleaned_data_selected3 <- cleaned_data_selected2 %>%
  group_by(hosp, year, month) %>%
  summarize(
    across(
      all_of(cols_to_sum),
      ~ if (all(is.na(.x))) NA_real_ else sum(.x, na.rm = TRUE)
    ),
    .groups = "drop"
  )
```


```{r}
vis_dat(cleaned_data_selected3[,-c(1:3)])

```





```{r}


numeric_cols <- names(cleaned_data_selected2)[5:48]

# Посчитаем количество месяцев с любыми NA по каждой больнице
hosp_na_counts <- cleaned_data_selected2 %>%
  group_by(hosp) %>%
  summarize(
    months_with_na = sum(if_any(all_of(numeric_cols), is.na)),
    .groups = "drop"
  )

# Выберем больницы, у которых количество таких месяцев <= 6
valid_hosp <- hosp_na_counts %>%
  filter(months_with_na <= 9) %>%
  pull(hosp)

# Отфильтруем исходный датафрейм, оставив только допустимые больницы
cleaned_data_selected4 <- cleaned_data_selected3 %>%
  filter(hosp %in% valid_hosp)


length(unique(cleaned_data_selected4$hosp))
```





```{r}
vis_dat(cleaned_data_selected4[,-c(1:4)])
```







Визуализация трендов по каждой больнице и году



```{r}


list_of_hosp <- cleaned_data_selected4 %>% 
  group_split(hosp, year)


for (i in seq_along(list_of_hosp)) {
  hosp_data <- list_of_hosp[[i]]
  

  hosp_name <- unique(hosp_data$hosp)
  year_name <- unique(hosp_data$year)
  

  if ("month" %in% colnames(hosp_data) && "Всего_с_ОНМК" %in% colnames(hosp_data)) {
    

    plot <- ggplot(hosp_data, aes(x = as.factor(month), y = Всего_с_ОНМК)) +
      geom_line(group = 1) +        
      geom_point() +                
      ggtitle(paste("Центр:", hosp_name, "| Год:", year_name)) +
      xlab("Месяц") +
      ylab("Всего с ОНМК") +
      theme_minimal()
    
    
    print(plot)
  } 
}



```







